
# 部署规划
## 数据库IP规划
Database_role|Hostname|IPaddr|IPaddr_priv|IPaddr_vip|IPaddr_scan|架构
-|-|-|-|-|-|-|-
Primary|ncloans1|172.16.108.100|100.100.100.100|172.16.108.102|172.16.108.115|双节点RAC
Primary|ncloans2|172.16.108.101|100.100.100.101|172.16.108.103|172.16.108.115|双节点RAC
-|-|-|-|-|-|-|-
Standby|ncloanstb|172.16.108.110|100.100.100.110|172.16.108.111|172.16.108.125|单节点RAC
## 数据库信息规划
Database_role|Hostname|sid|db_unique_name|db_name|操作系统版本
-|-|-|-|-|-
Primary|ncloans1|ncloans1|ncloans|ncloans|redhat6.10
Primary|ncloans2|ncloans1|ncloans|ncloans|redhat6.10
-|-|-|-|-|-
Standby|ncloanstb|ncloans1|ncloanstb|ncloans|redhat6.10
## 磁盘规划
主机|共享盘名|大小|类型
-|-|-|-
ncloans1/2|pridb-ocr1|5G|iscsi
ncloans1/2|pridb-ocr2|5G|iscsi
ncloans1/2|pridb-ocr3|5G|iscsi
ncloans1/2|pridb-ocr3|5G|iscsi
ncloans1/2|pridb-Recover|20G|iscsi
ncloans1/2|pridb-oradata|30G|iscsi
ncloans1/2|pridb-oradata1|10G|iscsi
-|-|-|-
ncloans|stddb-ocr1|5G|iscsi
ncloans|stddb-ocr2|5G|iscsi
ncloans|stddb-ocr3|5G|iscsi
ncloans|stddb-Recover|20G|iscsi
ncloans|stddb-oradata|30G|iscsi
ncloans|stddb-oradata1|10G|iscsi

# 基础配置
## 关闭透明大页以及numa特性
#备注:RAC环境所有的网卡里面添加配置：HOTPLUG=no
redhat6.*
```bash
cp /etc/grub.conf /etc/grub.conf.20191116
[root@ncloans1 ~]# vim /etc/grub.conf
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /boot/, eg.
#          root (hd0,0)
#          kernel /vmlinuz-version ro root=/dev/mapper/vg_ncloans1-lv_root
#          initrd /initrd-[generic-]version.img
#boot=/dev/sda
default=0
timeout=5
splashimage=(hd0,0)/grub/splash.xpm.gz
hiddenmenu
title Red Hat Enterprise Linux 6 (2.6.32-754.el6.x86_64)
        root (hd0,0)
        kernel /vmlinuz-2.6.32-754.el6.x86_64 ro root=/dev/mapper/vg_ncloans1-lv_root rd_NO_LUKS rd_LVM_LV=vg_ncloans1/lv_swap rd_LVM_LV=vg_ncloans1/lv_root rd_NO_MD SYSFONT=latarcyrheb-sun16  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM LANG=en_US.UTF-8 rhgb quiet transparent_hugepage=never numa=off --该处增加
        initrd /initramfs-2.6.32-754.el6.x86_64.img
```
redhat7.*
```bash
[root@ora19c1 ~]# cp /etc/sysconfig/grub /etc/sysconfig/grub.20191116
[root@ora19c1 ~]# cat /etc/sysconfig/grub
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"
GRUB_DEFAULT=saved
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT="console"
GRUB_CMDLINE_LINUX="spectre_v2=retpoline rd.lvm.lv=rhel_ora19c1/root rd.lvm.lv=rhel_ora19c1/swap rhgb quiet transparent_hugepage=never numa=off"
GRUB_DISABLE_RECOVERY="true"
[root@ora19c1 ~]#cp /boot/grub2/grub.cfg/boot/grub2/grub.cfg_20191116
[root@ora19c1 ~]#grub2-mkconfig -o /boot/grub2/grub.cfg
```
## 数据库节点信息配置
```bash
cat >> /etc/hosts << EOF
#primarydb
172.16.108.100  ncloans1
100.100.100.100  ncloans-priv1
172.16.108.102  ncloans-vip1
172.16.108.101  ncloans2
100.100.100.101  ncloans-priv2
172.16.108.103  ncloans-vip2
172.16.108.115  ncloans-scan
#standbydb
172.16.108.110  ncloanstb
100.100.100.110  ncloanstb-priv1
172.16.108.111  ncloanstb-vip1
172.16.108.125  ncloanstb-scan
EOF
```
## yum源配置
```bash
cat > /etc/yum.repos.d/rhel-source.repo << EOF
[rhel]
name=rhel
baseurl=file:///media
enable=1
gpgcheck=0
EOF
```
## 依赖库安装
```bash
#依赖包检查
rpm -q --qf '%{NAME}-%{VERSION}-%{RELEASE}(%{ARCH})\n' binutils compat-libstdc++-33 elfutils-libelf elfutils-libelf-devel gcc gcc-c++ glibc glibc-common glibc-devel glibc-headers ksh libaio libaio-devel libgcc libstdc++ libstdc++-devel make sysstat numactl unixODBC unixODBC-devel | grep "not installed"
#依赖包安装
yum install -y libaio-* glibc-* glibc-devel* libaio-* compat-libstdc++-* libgcc-* libstdc++-* unixODBC-* compat-libcap1-1.10-1.* gcc* elfutils-libelf-*
```
## 用户及用户创建
```bash
groupadd -g 1000 oinstall
groupadd -g 1020 asmadmin
groupadd -g 1021 asmdba
groupadd -g 1022 asmoper
groupadd -g 1031 dba
groupadd -g 1032 oper
useradd -u 1100 -g oinstall -G asmadmin,asmdba,asmoper,oper,dba grid
useradd -u 1101 -g oinstall -G dba,asmdba,oper oracle
echo oracle|passwd --stdin oracle
echo grid|passwd --stdin grid
```
## 用户环境变量配置
```bash
#请自行根据实际情况修改ORACLE_UNQNAME以及ORACLE_SID变量
cat >> /home/oracle/.bash_profile << EOF
#########################################################
export ORACLE_UNQNAME=primarydb
TMP=/tmp; export TMP
TMPDIR=\$TMP; export TMPDIR
ORACLE_BASE=/u01/app/oracle; export ORACLE_BASE
ORACLE_HOME=\$ORACLE_BASE/product/11.2.0; export ORACLE_HOME
ORACLE_SID=ncloans1; export ORACLE_SID
ORACLE_TERM=xterm; export ORACLE_TERM
PATH=/usr/sbin:\$PATH; export PATH
PATH=$ORACLE_HOME/bin:\$PATH; export PATH
LD_LIBRARY_PATH=\$ORACLE_HOME/lib:/lib:/usr/lib; export LD_LIBRARY_PATH
CLASSPATH=\$ORACLE_HOME/JRE:\$ORACLE_HOME/jlib:\$ORACLE_HOME/rdbms/jlib; export CLASSPATH
NLS_DATE_FORMAT="yyyy-mm-dd HH24:MI:SS"; export NLS_DATE_FORMAT
export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK
if [ $USER = "oracle" ] || [ $USER = "grid" ]; then
if [ $SHELL = "/bin/ksh" ]; then
ulimit -p 16384
ulimit -n 65536
else
ulimit -u 16384 -n 65536
fi
umask 022
fi
#########################################################
EOF

cat >> /home/grid/.bash_profile << EOF
#################################################################
TMP=/tmp; export TMP
TMPDIR=\$TMP; export TMPDIR
ORACLE_SID=+ASM1; export ORACLE_SID
ORACLE_BASE=/u01/app/grid; export ORACLE_BASE
ORACLE_HOME=/u01/app/11.2.0/grid; export ORACLE_HOME
NLS_DATE_FORMAT="yyyy-mm-dd HH24:MI:SS"; export NLS_DATE_FORMAT
THREADS_FLAG=native; export THREADS_FLAG
PATH=$ORACLE_HOME/bin:\$PATH; export PATH
THREADS_FLAG=native; export THREADS_FLAG
export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK
PATH=\$ORACLE_HOME/bin:\$PATH; export PATH
if [ $USER = "oracle" ] || [ $USER = "grid" ]; then
if [ $SHELL = "/bin/ksh" ]; then
ulimit -p 16384
ulimit -n 65536
else
ulimit -u 16384 -n 65536
fi
umask 022
fi
#################################################################
EOF
```
## 用户资源限制配置
```bash
cat >> /etc/pam.d/login << EOF
session    required     pam_limits.so
EOF
```
```bash
cat >> /etc/security/limits.conf << EOF
grid soft nofile 1024
grid hard nofile 65536
grid soft nproc 2047
grid hard nproc 16384
oracle soft nofile 1024
oracle hard nofile 65536
oracle soft nproc 2047
oracle hard nproc 16384
oracle hard memlock 3145728   -该处建议增加内存限制一般为内存大小的80%
oracle soft memlock 3145728   -该处建议增加内存限制一般为内存大小的80%
EOF
```
## 创建目录
```bash
创建目录及授权
mkdir /u01
chown -R grid:oinstall /u01
chmod -R 755 /u01
mkdir -p /u01/app/oracle
chown -R oracle:oinstall /u01/app/oracle/
mkdir -p /u01/app/grid
chown grid:oinstall /u01/app/grid/
mkdir -p /u01/app/11.2.0/grid
chown grid:oinstall /u01/app/11.2.0/grid/
mkdir -p /u01/app/oraInventory
chown grid:oinstall /u01/app/oraInventory
su - oracle
mkdir -p $ORACLE_HOME
exit
su - grid
mkdir -p $ORACLE_HOME
exit
```
## ntp配置
```bash
sed -i 's/-u/-x -u/g' /etc/sysconfig/ntpd
cat >> /etc/sysconfig/ntpd << EOF
SYNC_HWCLOCK=yes
EOF
```
## 互信配置
```bash
ssh-keygen -t rsa
ssh-copy-id ncloans1
ssh ncloans1 date;ssh ncloans2 date
```
## 存储盘配置
```bash
[root@ncloans1 ~]# cat /etc/multipath.conf
blacklist {
    devnode "^sda"
}
defaults {
    user_friendly_names yes
    path_grouping_policy multibus
    failback immediate
    no_path_retry fail
}
multipaths {
       multipath {
               wwid	"14f504e46494c455263666367426f2d327064592d4a346975"
               alias	ocr1
       }
       multipath {
               wwid	"14f504e46494c45527937436944442d304761742d4e61504f"
               alias	ocr2
       }
       multipath {
               wwid	"14f504e46494c455264786452384f2d545a65642d52344f4a"
               alias	ocr3
       }
       multipath {
               wwid	"14f504e46494c455273443334324a2d31514c742d5a7a6561"
               alias	recover
       }
       multipath {
               wwid	"14f504e46494c45526153306172662d56314d572d42513662"
               alias	oradata
       }
       multipath {
               wwid	"14f504e46494c45527852643639622d467166482d54776471"
               alias	oradata1
       }
}
[root@ncloans1 ~]# cat /etc/udev/rules.d/12-dm-permissions.rules
ENV{DM_NAME}=="ocr1",OWNER:="grid",GROUP:="asmadmin",MODE:="660",SYMLINK+="mapper/$env{DM_NAME}"
ENV{DM_NAME}=="ocr2",OWNER:="grid",GROUP:="asmadmin",MODE:="660",SYMLINK+="mapper/$env{DM_NAME}"
ENV{DM_NAME}=="ocr3",OWNER:="grid",GROUP:="asmadmin",MODE:="660",SYMLINK+="mapper/$env{DM_NAME}"
ENV{DM_NAME}=="recover",OWNER:="grid",GROUP:="asmadmin",MODE:="660",SYMLINK+="mapper/$env{DM_NAME}"
ENV{DM_NAME}=="oradata",OWNER:="grid",GROUP:="asmadmin",MODE:="660",SYMLINK+="mapper/$env{DM_NAME}"
ENV{DM_NAME}=="oradata1",OWNER:="grid",GROUP:="asmadmin",MODE:="660",SYMLINK+="mapper/$env{DM_NAME}"
```
## 防火墙关闭
```bash
service iptables stop;service ip6tables stop
chkconfig --level 35 iptables off
chkconfig --level 35 ip6tables off
```
##  安装cvuqdisk
```bash
[grid@ncloanstb rpm]$ pwd
/home/grid/grid/rpm
[grid@ncloanstb rpm]$rpm -ivh cvuqdisk-1.0.9-1.rpm
```
# 以上Oracle数据库RAC环境基础配置完成，请自行安装grid以及oracle.其安装过程不进行示例
## 主备库静态监听配置
```bash
cat >> $GRID_HOME/network/admin/listener.ora << EOF
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = ncloans)
      (ORACLE_HOME = /u01/app/oracle/product/11.2.0)
      (SID_NAME = ncloans1)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = ncloans_DGMGRL)
      (SID_NAME = ncloans1)
      (ORACLE_HOME = /u01/app/oracle/product/11.2.0)
    )
  )

SID_LIST_LISTENER_SCAN1 =
    (SID_LIST =
        (SID_DESC =
            (GLOBAL_DBNAME = ncloans)
            (SID_NAME = ncloans1)
            (ORACLE_HOME = /u01/app/oracle/product/11.2.0)
        )
    )
EOF
```
## 主备库的连接字符串配置
```bash
cat >> $ORACLE_HOME/network/admin/tnsnames.ora << EOF
NCLOANS =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = ncloans-scan)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = ncloans)
    )
  )
NCLOANSTB =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = ncloanstb-scan)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = ncloanstb)
    )
  )
primary =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.108.102)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SID = ncloans1)
    )
  )
standby =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.108.111)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SID = ncloans1)
    )
  )
EOF
#备注：
连接字符串：NCLOANS以及NCLOANSTB 这2个连接字符串用于dg传输归档文件
            primary以及standby 这2个连接字符串用于使用rman在线恢复备库使用
```
## 数据库配置
```bash
1、alter database force logging;
2、开启归档
3、创建standby log日志组
alter database add standby logfile thread 1 group 21 ('+RECOVER','+ORADATA') size 50m;
alter database add standby logfile thread 1 group 22 ('+RECOVER','+ORADATA') size 50m;
alter database add standby logfile thread 1 group 23 ('+RECOVER','+ORADATA') size 50m;
alter database add standby logfile thread 2 group 24 ('+RECOVER','+ORADATA') size 50m;
alter database add standby logfile thread 2 group 25 ('+RECOVER','+ORADATA') size 50m;
alter database add standby logfile thread 2 group 26 ('+RECOVER','+ORADATA') size 50m;
```
## DG参数配置
### DG参数配置查询语句
```sql
set linesize 250
col namr for a30
col value for a100
set pages 100
select name, value from v$parameter where name in ('db_name','db_unique_name','log_archive_config', 'log_archive_dest_1','log_archive_dest_2','log_archive_dest_state_1','log_archive_dest_state_2', 'remote_login_passwordfile','log_archive_format','log_archive_max_processes','fal_server','db_file_name_convert','log_file_name_convert', 'standby_file_management');
```
### DG参数配置主库
```bash
alter system set db_name='ncloans' scope=spfile;    --安装已配置无需再进行配置
alter system set db_unitue_name='ncloans' scope=spfile;   -安装已配置无需再进行配置
alter system set fal_client='ncloans' scope=both sid='*';
alter system set fal_server='ncloanstb' scope=both sid='*';
alter system set LOG_ARCHIVE_CONFIG='DG_CONFIG=(ncloans,ncloanstb)' scope=both sid='*';
alter system set LOG_ARCHIVE_DEST_1='LOCATION=USE_DB_RECOVERY_FILE_DEST VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=ncloans' scope=both sid='*';
alter system set LOG_ARCHIVE_DEST_2='SERVICE=ncloanstb lgwr async VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=ncloanstb' scope=both sid='*';
alter system set log_archive_format='%t_%s_%r.arc' scope=spfile sid='*';
alter system set log_archive_max_processes=8 scope=both sid='*';
alter system set db_file_name_convert='+ORADATA/ncloans','+ORADATA/ncloanstb' scope=spfile sid='*';
alter system set log_file_name_convert='+ORADATA/ncloans','+ORADATA/ncloanstb','+REOVER/ncloans','+REOVER/ncloanstb' scope=spfile sid='*';
alter system set standby_file_management=AUTO scope=both sid='*';
## 此处需要重启数据库
```
### DG参数配置备库
```bash
alter system set db_name='ncloans' scope=spfile;    --该处同主库保持一致
alter system set db_unitue_name='ncloanstb' scope=spfile;   -该处的名字与主库不同
alter system set fal_client='ncloanstb' scope=both sid='*';
alter system set fal_server='ncloans' scope=both sid='*';
alter system set LOG_ARCHIVE_CONFIG='DG_CONFIG=(ncloanstb,ncloans)' scope=both sid='*';
alter system set LOG_ARCHIVE_DEST_1='LOCATION=USE_DB_RECOVERY_FILE_DEST VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=ncloanstb' scope=both sid='*';
alter system set LOG_ARCHIVE_DEST_2='SERVICE=ncloans lgwr async VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=ncloans' scope=both sid='*';
alter system set log_archive_format='%t_%s_%r.arc' scope=spfile sid='*';
alter system set log_archive_max_processes=8 scope=both sid='*';
alter system set db_file_name_convert='+ORADATA/ncloanstb','+ORADATA/ncloans' scope=spfile sid='*';
alter system set log_file_name_convert='+ORADATA/ncloanstb','+ORADATA/ncloans','+REOVER/ncloanstb','+REOVER/ncloans' scope=spfile sid='*';
alter system set standby_file_management=AUTO scope=both sid='*';
## 此处需要重启数据库
```
## 密码文件拷贝
```bash
直接将主库任意节点的密码文件scp至备库的$ORACLE_HOME/dbs目录，根据实际情况重新命名
# 11g的密码文件存放于本地盘中，12c及以后的版本密码文件存放于asm共享磁盘中
```
## 恢复备库
```bash
#在主库生成pfile文件根据实际情况修改后scp至备库，在备库使用该pfile文件将数据库启动至nomount状态，具体修改参数请参考“DG参数配置备库”
[oracle@ncloanstb ~]$rman target sys/oracle@primary auxiliary sys/oracle@standby
RMAN> duplicate target database for standby nofilenamecheck from active database;
#恢复前请检查$ORACLE_HOME/bin/oracle 文件权限用户属组是否是"asmadmin",如果为否请执行以下命令:
/u01/app/11.2.0/grid/bin/setasmgidwrap -o /u01/app/oracle/product/11.2.0/bin/oracle
```
## 备库状态检查
```bash
1、检查数据库状态是否处于只读及日志应用状态，如不是请执行以下语句
SQL> alter database open;     --将数据库打开
SQL> select open_mode from v$database;    --检查数据库状态，如果不是日志应用请执行下条语句
SQL> alter database recover managed standby database using current logfile disconnect from session;   --启动日志实时应用
2、同步检查主备库所有节点的alert日志
3、在主库创建任意用户或表随后在备库查看是否存在
```
## 由于备库是单实例RAC数据库，所以需要注册数据库
```bash
#在rman恢复备库后数据库的参数文件即spfile文件会处于本地盘中，建议将该文件存放在asm中，步骤如下：
1、create pfile from spfile;
2、create spfile='+ORADATA' from pfile;
3、使用grid用户在asm的ORADATA磁盘组中找到该文件所处的目录
4、修改$ORACLE_HOME/dbs/initncloans1.ora文件内容指向，示例如下：
  [root@ncloanstb ~]# cat /u01/app/oracle/product/11.2.0/dbs/initncloans1.ora
  SPFILE='+oradata/DB_UNKNOWN/PARAMETERFILE/SPFILE.275.1024502869'
5、添加注册数据库
srvctl add database -d ncloanstb -o /u01/app/oracle/product/11.2.0 -n ncloans -p +oradata/DB_UNKNOWN/PARAMETERFILE/SPFILE.275.1024502869
srvctl modify database -d ncloanstb -a "ORADATA,RECOVER"
srvctl add instance -d ncloanstb -i ncloans1 -n ncloanstb
srvctl config database -d ncloanstb   --检查数据库信息该处对比主库信息
srvctl start database -d ncloanstb   --启动数据库测试并观察alert日志
```
## DG broker配置
```bash
备库
alter system set dg_broker_config_file1='+ORADATA/dgbroker/ncloanstb.dat' scope=both sid='*';
alter system set dg_broker_config_file2='+RECOVER/dgbroker/ncloanstb.dat' scope=both sid='*';
alter system set dg_broker_start=true scope=both sid='*';

主库
alter system set dg_broker_config_file1='+ORADATA/dgbroker/ncloans.dat' scope=both sid='*';
alter system set dg_broker_config_file2='+RECOVER/dgbroker/ncloans.dat' scope=both sid='*';
alter system set dg_broker_start=true scope=both sid='*';

[oracle@ncloanstb ~]$ dgmgrl sys/oracle
DGMGRL for Linux: Version 11.2.0.4.0 - 64bit Production

Copyright (c) 2000, 2009, Oracle. All rights reserved.

Welcome to DGMGRL, type "help" for information.
Connected.
DGMGRL>create configuration 'DG_ConFig' as primary database is 'ncloans' connect identifier is 'ncloans';
DGMGRL>add database 'ncloanstb' as connect identifier is 'ncloanstb';
DGMGRL>enable configuration
DGMGRL>show configuration
DGMGRL>switchover to ncloanstb    --数据库切换操作
```
## Oracle Dataguard常用sql
```bash
手动切换dataguard
dataguard启动关闭顺序
(1)监听
先启从库再起主库
   #lsnrctl start
(2)启动
先启从库：
sql>startup nomount
sql>alter database mount standby database;（10g）
sql>alter database mount(11g)
sql>alter database open(11g)
sql>alter database recover managed standby database using current logfile disconnect from session;
启动日志应用模式
在启主库
sql>startup
(3)关闭：和开启正好相反
先关主库：
sql>shutdown immediate
再关从库：
sql>alter database recover managed standby database cancel;
管理模式
sql>shutdown immediate
select open_mode from v$database (查看主备库的打开状态信息)
select database_role from v$database(查看数据库状态信息)
```